import urllib
import re
import requests
import time
import subprocess
import io
import ctypes
from contextlib import redirect_stdout

#basic data
url = "https://ringzer0team.com/challenges/121"
sessId = "9umjt9pup125obfarp0mc23ih2"
session = requests.session()
libc = ctypes.CDLL(None)
#raw data
def get_data():
	request = session.get(url, cookies={"PHPSESSID":sessId})
	raw = request.text
	begin = raw.find("----- BEGIN SHELLCODE -----")+35
	end = raw.find("----- END SHELLCODE -----")-10
	content = raw[begin:end]
	return content.strip()

#process data
def process_data(data):
	code_str = '#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\nunsigned char code[] = "'
	code_str += str(data) + '";\nint main(){\n(*(void(*)())code)();\nsetvbuf(stdout, NULL, _IOFBF, 1024);\nreturn (0);}\n'
	file = open("test.c", "w")
	file.write(code_str)
	file.close()
	subprocess.Popen(["gcc", "-g", "-Wall", "-fno-stack-protector", "-zexecstack", "test.c", "-otest"])
	pipe = subprocess.Popen(["./test"], stdout = subprocess.PIPE, shell=True)
	out, err = pipe.communicate()
	pipe_status = pipe.wait()
	print("\nTEST:", str(out))
	##TEST##
	# proc = subprocess.run(["./pyshell.py", str(data)], stdout = subprocess.PIPE, stderr = subprocess.STDOUT, shell = True)
	# print("TEST : ", proc.stdout.decode("utf-8"))
	#return res

if __name__ == "__main__":
	shellcode = get_data()
	answer = process_data(shellcode)
	print("\nFROM MAIN : ", str(answer))
